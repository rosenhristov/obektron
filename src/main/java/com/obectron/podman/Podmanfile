# Standard build
#FROM eclipse-temurin:21-jdk
#ARG VERSION=0.0.1-SNAPSHOT
#LABEL maintainer="rosenhrist@gmail.com" version="${VERSION}"
#ENV VERSION=${VERSION}
#RUN apt-get update && apt-get install -y curl  && useradd -m obectron-user && rm -rf /var/lib/apt/lists/*
#WORKDIR /app
#COPY build/libs/obectron-${VERSION}.jar obectron.jar
#VOLUME /data
#EXPOSE 8080
#USER obectron-user
#ENTRYPOINT ["java", "-jar", "obectron.jar"]

# ============ 1️⃣ Build Stage ============
FROM gradle:8.10-jdk21 AS build
WORKDIR /build
# Copy source code and dependencies:
COPY build.gradle settings.gradle ./
COPY src ./src
# Build the fat JAR (Spring Boot) quickly by skipping the tests:
RUN gradle clean bootJar -x test

# ============ 2️⃣ Runtime Stage ============
FROM eclipse-temurin:21-jre-alpine
# Аргументи и метаданни:
ARG VERSION=0.0.1-SNAPSHOT
LABEL maintainer="rosenhrist@gmail.com" version="${VERSION}"
ENV VERSION=${VERSION}
# Създаване на non-root потребител:
RUN adduser -D -h /obectron obectron-user
WORKDIR /obectron
# Copy the JAR built during the BUILD stage:
COPY --from=build /build/build/libs/obectron-${VERSION}.jar obectron.jar
# Data and port:
VOLUME /data
EXPOSE 8000
# Use the non-root user when starting the pod:
USER obectron-user
#Start the pod:
ENTRYPOINT ["java", "-jar", "obectron.jar"]

# Build image command from project root:
# podman build -f src\main\java\com\obectron\podman\Podmanfile -t obectron:latest --build-arg VERSION=0.0.1-SNAPSHOT .
